<template>
  <div class="header" :class="header_position">
    <img class="logoimg"  v-bind:src="logo">
    <div class="h_menu">
      <div class="h_menu_btn_all" v-if=true  v-for="(v,i) in menujson">
        <a class="h_menu_btn"  v-if="locationHref.indexOf(v.menuUrl) == -1"  :href="v.menuUrl" target="_self" >{{ v.menuName}}</a>
        <a class="h_menu_btn btn_selected" v-else  :href="v.menuUrl" target="_self" >{{ v.menuName}}</a>
        <!--<div class="h_menu_line" v-if="i < (menujson.length-1)"><img v-bind:src="sx_line"></div>-->
      </div>
    </div>
    <div class="h_user">
      <div class="_h_user" @click="toLogin">
        <div class="h_user_img"></div>
        <div class="h_user_txt">{{who}}</div>
      </div>
      <div class="_h_user" @click="logout_sure = true" v-if="logoutBtn">
        <div class="h_user_img"></div>
        <div class="h_user_txt">退出</div>
      </div>
    </div>
    <Modal
      v-model="logout_sure"
      title="即将退出"
      @on-ok="logout_ok"
      @on-cancel="logout_cancel">
      <p>是否退出当前登录用户？</p>
    </Modal>
  </div>
</template>
<script>
  import axios from 'axios'
  import global_   from  './global'
  import cookie_   from  './cookie'
  import login_   from  './login'
  import logo from "../header/logo.png"
  import sx_line from "../header/sx.png"

  axios.defaults.withCredentials=true;//使axios发送ajax请求时携带浏览器cookie信息

  export default {
    components: {axios},
    name: "myhead",
    props:['isgo','apptype'],
    data(){
      return{
        header_position:'headFix',
        logo:logo,
        locationHref:'',
        sx_line:sx_line,
        logoutBtn:false,//注销按钮显示
        logout_sure:false,//注销按钮显示
        icdp_ip:':8000',//设置请求端口
        menujson : [],//菜单数组,
        who : '请登录',//用户名
        showLogin:false,//是否显示登陆界面
        rem_user:true,//是否记住密码
        ruleForm:{//账号密码(用户信息)
          userName:"",
          password:""
        },
      }
    },
    created:function () {
      //判断当前是哪个模块
      this.locationHref = window.location.href;

      //判断是否相对浏览器定位
      console.log("apptype:"+this.apptype)
      if(this.isgo){
        this.header_position = 'headFix'
      }else {
        this.isgo = false;
        this.header_position = 'headNoFix'
      };
      //判断当前模块，设置请求端口
      if(this.apptype == 'app01'){
        this.icdp_ip = ':8000';
      }else if(this.apptype == 'app02'){
        this.icdp_ip = ':8002';
      }else if(this.apptype == 'app03'){
        this.icdp_ip = ':8003';
      }else if(this.apptype == 'app04'){
        this.icdp_ip = ':8004';
      }else if(this.apptype == 'app05'){
        this.icdp_ip = ':8005';
      };
      console.log('端口号:'+this.icdp_ip);
      //发送请求获取JSON数据
      this.getMenu();
      // 验证token：
      this.v_token(this.getQueryString("token"));
    },
    mounted:function () {

    },
    methods:{
      getMenu:function () {
        axios({
          method: 'post',
          url: global_.moudel_url,
          data: {}
        }).then((parm)=>{
          console.log(parm);
          this.menujson = parm.data;
          for(var i = 0 ; i < this.menujson.length; i++){
            let aa = this.locationHref.indexOf(this.menujson[i].menuUrl);
            console.log(this.locationHref+"|||"+this.menujson[i].menuUrl+"|||"+aa);
          }
        }).catch((error)=>{});
      },
      getQueryString:function(name) {
        var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
        var urlSearch = window.location.search.substr(1);
        if(urlSearch == null || urlSearch == '' || urlSearch == undefined){
          urlSearch = window.location.href.split('?')[1];
        };
        if(urlSearch == null || urlSearch == '' || urlSearch == undefined){
          return 'null'
        };
        var r = urlSearch.match(reg);
        if (r != null) {
          return r[2];
        }
        return 'null';
      },
      setUserName:function (na) {
        if(na == '请登录'){
          this.logoutBtn = false;
        }else {
          this.logoutBtn = true;
        }
        this.who = na;
      },
      toLogin:function () {
        if(this.who == "请登录"){
          login_.toLogin(this.apptype);
        }else {
          //用户已经登陆过
          return false;
        }
      },
      outLogin:function () {
        cookie_.delCookie('username');
        cookie_.delCookie('nickname');
        cookie_.delCookie('uliweb_session_id');
        this.setUserName('请登录');
        axios.get(global_.icdp_url+this.icdp_ip+'/logout',
          {params: {}}).then((parm)=>{
          console.log(parm);
        }).catch((error)=>{})
        //跳转到注销页面
        login_.toLogout();
      },
      v_token:function (tk) {
        console.log("token:"+tk);
        if(tk == 'null' || tk == null || tk=='' || tk == undefined){
          console.log('验证是否登陆前的cookie:'+document.cookie);
          //验证用户是否登陆，发送请求获取，有可能用户在其他页面做过登陆操作。
          axios.get(global_.login2_url+'/api/checkLogin',
            {params: {}}).then((parm)=>{
            console.log(parm);
            let parmdata = parm.data;
            console.log("nickname："+parmdata.nickname+"||username："+parmdata.username);
            cookie_.setCookie('nickname',parmdata.nickname,'d30');
            cookie_.setCookie('username',parmdata.username,'d30');
            // document.cookie = 'nickname='+parmdata.nickname;
            // document.cookie = 'username='+parmdata.username;
            console.log('验证是否登陆后的cookie:'+document.cookie);
            //调用后台api，将用户信息发送给后台，保存在session中。
            this.login_save(parmdata);
            //判断用户是否登陆，如果不是首页，则强制登陆
            this.mustLogin(parmdata);
          }).catch((error)=>{})
        }else {
          console.log('验证token,返回用户验证信息');
          axios.get(global_.icdp_url+this.icdp_ip+'/login_suf',
            {
              params: {
                token:tk,
                next:''
              }
            }).then((parm)=>{
            console.log("验证token结束");
            let parmdata = parm.data;
            if(parmdata.success){
              console.log(parmdata.nickname);
              this.setUserName(parmdata.nickname);
              cookie_.setCookie('nickname',parmdata.nickname,'d30');
              cookie_.setCookie('username',parmdata.username,'d30');
              var locaurl = login_.getUrl();
              window.location.href = locaurl;
            }else {
              alert(parmdata.message);
            }
          }).catch((error)=>{})

        }
      },
      login_save:function (pa) {
        console.log("保存用户之前的cookie:"+document.cookie)
        axios.get(global_.icdp_url+this.icdp_ip+'/login_save',
          {
            params: pa
          }).then((parm)=>{
          console.log("保存用户结束:"+parm.data);
          console.log("保存用户结束的cookie:"+parm.data);
        }).catch((error)=>{})
      },
      mustLogin : function (pdata) {
        if(pdata.nickname == '' || pdata.nickname == null || pdata.nickname == undefined || pdata.username == '' || pdata.username == null || pdata.username == undefined){
          this.setUserName('请登录');
          if(this.apptype == 'app01'){
            //首页，不做处理
            return;
          }else {
            //非首页，强制登陆\
            login_.toLogin(this.apptype);
          }
        }else {
          this.setUserName(pdata.nickname || pdata.username);
        }
      },
      logout_ok : function () {
        console.log("确认注销");
        this.outLogin();
      },
      logout_cancel : function () {
        console.log("取消注销")
      }
    },
	}
</script>
<style lang="less" scoped>
.headFix{
  position: fixed;
  top: 0px;
  left: 0px;
  z-index:2018725;
}
.headNoFix{
  position: relative;
  top: 0px;
  left: 0px;
  z-index: 2017;
}
.header{
  width: 100%;
  min-width: 750px;
  /*max-width: 1000px;*/
  height: 59px;
  text-align: left;
  background-color:#eeeeee;
  overflow: hidden;

  .logoimg{
    float: left;
    margin-left: 23px;
    margin-top: 7px;
    /*height: 22px;*/
    width: 134px;
  }

  .h_menu{
    height: 100%;
    width: auto;
    float: left;
    padding-left: 70px;

    .h_menu_btn_all{
      float: left;
      width: auto;
      height: auto;
      overflow: hidden;

      .h_menu_btn{
        float: left;
        padding:0 10px;
        width: auto;
        height: 59px;
        line-height: 59px;
        font-size: 18px;
        font-weight: bold;
        /*color: #5e5e5e;*/
        color: rgba(38,24,11,0.87);
        letter-spacing: 2px;
        /*color: rgba(33,45,167,0.8);*/
        cursor: pointer;

        &:hover{
          color: #01babc;
        }
      }
      .btn_selected{
        color: #01babc;
      }
      .h_menu_line{
        float: left;
        width: 1px;
        height: 26px;
        margin-top: 17px;
        /*background:url("./sx.png") 100% 100% no-repeat;*/

        img{
          width: 1px;
          height: 26px;
          /*height: 100%;*/
        }
        /*background: -webkit-linear-gradient(#eeeeee,#666666,#eeeeee); !* Safari 5.1 - 6.0 *!*/
        /*background: -o-linear-gradient(#eeeeee,#666666,#eeeeee); !* Opera 11.1 - 12.0 *!*/
        /*background: -moz-linear-gradient(#eeeeee,#666666,#eeeeee); !* Firefox 3.6 - 15 *!*/
        /*background: linear-gradient(#eeeeee,#666666,#eeeeee); !* 标准的语法 *!*/
      }
    }
  }
  .h_user{
    float: right;
    width: auto;
    height: 100%;
    overflow: hidden;

    ._h_user{
      width: auto;
      height: 100%;
      float: left;
      margin-right: 10px;
      overflow: hidden;
      cursor: pointer;

      .h_user_img{
        width: 20px;
        height: 20px;
        margin-top: 19px;
        float: left;
        background-image: url("u63.png");
        background-repeat: no-repeat;
        background-size: 100% 100%;
      }
      .h_user_txt{
        float: left;
        height: 100%;
        line-height: 59px;
        margin-left: 5px;
      }
    }
  }
}
</style>
